<!DOCTYPE html>
<html>
	    <head>
				<title>black diamond webcam range</title>
				<link rel="stylesheet" type="text/css" href="./mobileslider.css" >
		</head>

	   	<body>

			<!--<div id="menu" style="position: absolute; top: 0; width: 100%; background-color: #FFFFFF;"> -->
			<div id="menu" style="width: 100%; background-color: #FFFFFF;">
				<div class="dateradio">
					<label>
						<input type="radio" name="date" value="recent" checked="checked" > Use most recent images
					</label><br>

					<label>
						<input type="radio" name="date" value="date"  > Select date(s) to display 
					</label><br>
				</div>

				<div id="datespecific" style="display: none;">
					<br>
					<label for="startdate"> Start Date: </label>
					<input type="date" id="startdate" name="start" min="2025-05-26" />
					<br>
					<label for="enddate"> End Date: </label>
					<input type="date" id="enddate" name="end" min="2025-05-26" />
					<br>

					<button type=button id="datesubmit" style="width: 250px; height: 50px; font-size: 20px;"> Load Selection </button>
				</div>

				<div class="slidecontainer" >
					<div id="minutesago">
					<p>Current: <span id="stext"></span> </p>
          			</div>

					<p>Timestamp (MDT): <span id="timetxt"></span></p>

					<div style="display: inline;">
						  <button type=button  style="width: 40px; height: 40px;font-size: 30px;"> - </button>
						  <button type=button  style="width: 40px; height: 40px; font-size: 30px;"> + </button> 
					</div>
					<input type="range" style="width: 70%; height: 100px;"  step="1" min="" max="0" value="0" class="slider" id="snapsrange">
					<br>
					<button type=button id="loadbtn" style="width: 250px; height: 50px; font-size: 20px;"> Load another 50 images </button>
				</div>	
			</div>
			<img src="https://volcview.wr.usgs.gov/ashcam-api/images/webcams/ys-bbsn/current.jpg" alt="webcam_image" style="height:75vmin; " id="webcam"> 
			<br>
			<a href="https://github.com/Joel-Hecht/Black_Diamond_Webcam_Monitor"> github page </a>

		<script>
			//0 = recent mode, 1 = date selection mode
			var OP_MODE  = 0;

			var slider = document.getElementById("snapsrange");
			var slidertext = document.getElementById("stext");
			var timetext = document.getElementById("timetxt");
			var webcam = document.getElementById("webcam");

			var nextmax = 99999999999999999; //unix time of the next maximum, by defualt is infinity or something
			slidertext.innerHTML="<15 minutes ago"

			var globvalue = 0;	
			var images = [];
			var data = [];

			// allow view to shift when radio button value is changed
			const radioButtons = document.querySelectorAll('input[name="date"]');
			radioButtons.forEach( radio => {
				radio.addEventListener('change', function() {
					var selected = this.value;
					changeMode(selected);	
				});
			});

			//date selection stuff
			let date = new Date();
			let strdate = date.toISOString().slice(0,10);
			let sdate = document.getElementById("startdate");
			sdate.max = strdate;
			sdate.value = strdate;
			let edate = document.getElementById("enddate");
			edate.max = strdate;
			edate.value = strdate;
	
			subbtn = document.getElementById("datesubmit");
			
			var date_ssec;
			var date_esec;
			subbtn.addEventListener("click", function () {
				let s = sdate.value;
				let e = edate.value;
				let ed = new Date(e);
				let sd = new Date(s);
				
				const day_seconds = 86400;
				const mdt_conversion_factor = 21600;

				let sseconds = Math.floor(sd.getTime() / 1000);
				let eseconds = Math.floor(ed.getTime() / 1000);
				
				//because we want this at the END of the day
				eseconds= eseconds + day_seconds;

				date_ssec = sseconds + mdt_conversion_factor;
				date_esec = eseconds + mdt_conversion_factor;

				console.log(sseconds);
				console.log(eseconds);

				loadDateRange();	
			});
	
	
			//default functionality

			slider.oninput = recalculateSlider;

			function changeMode(value) {

				//reset all cached images
				//images = [];

				if (value === "recent") {
					OP_MODE = 0;
					hideElement("datespecific");
					showElement("loadbtn");
					showElement("minutesago");	
					
					//var nextmax = 99999999999999999; 
					//reset to default 50 img veiw
					//changeRange('50');
				}
				else {
					OP_MODE = 1;
					showElement("datespecific");
					hideElement("loadbtn");
					hideElement("minutesago");	
				}
			}

			function recalculateSlider() {
				slidertext.innerHTML = "<" + ((parseInt(slider.max) - parseInt(slider.value)) * 15).toString() + " minutes ago";
				globvalue = slider.value;	
				webcam.src = images[globvalue - 1][1]; 

				let t = images[globvalue - 1 ][0];

				var date = new Date(t * 1000); // convert to milliseconds

				// Use toLocaleString with America/Denver timezone (handles MST/MDT automatically)
				var datestring = date.toLocaleString('en-US', {
					timeZone: 'America/Denver',
					year: 'numeric',
					month: '2-digit',
					day: '2-digit',
					hour: '2-digit',
					minute: '2-digit',
					hour12: false
				});


				timetext.innerHTML = datestring;
			}

			function setData(d) {
				data = Array.from(d);
				//console.log(data);
			}

			async function fetchJSONData(count) {
			    var obj;
				
				var webcam_sec_start;
				var webcam_sec_end;
				var image_limit;
				if (OP_MODE == 0) {
					 //recent mode 
					webcam_sec_start = 0;
					webcam_sec_end = nextmax;
				} else {
					webcam_sec_start = date_ssec
					webcam_sec_end=date_esec;

				}
				var jsonlink= "https://proxy.catboyjoel.com/get?url=" + "https://volcview.wr.usgs.gov/ashcam-api/imageApi/webcam/ys-bbsn/" + webcam_sec_start.toString() + "/" + webcam_sec_end.toString() + "/newestFirst/" + count.toString();
				console.log(jsonlink);
				await fetch( jsonlink , { 
					//prevent caching here because it will not update with latest json
					headers: {
					 	//'Content-Type': 'application/json',
						//'Cache-Control': 'no-cache'
					}
				 })
				.then(response => {
				    if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`);
				    }
				    return response.json();  
				})
				.then((data) => {  obj = data["images"]; return obj; })
				.then(() => {console.log(obj);}); 
				//.catch(error => console.error('Failed to fetch data:', error)); 
			
			    console.log(obj);
			    return obj;
			}

			function cacheimages(images, range) {
				if (typeof cacheimages.list === 'undefined'){
					cacheimages.list = [];
				}
				for (let i = 0 ; i < range; i++) {
					var img = new Image();
					cacheimages.list.push(img);
					//delete references later if this works
					img.src = images[i];
					console.log("cached:");
					console.log(images[i]);
				}
			}

			async function changeRange(range) {
				
				let thisadd =  parseInt(range) - slider.max; //assume we exclusively are increasing range from previous

				slider.max = range;
				slider.value = range;

				console.log("new range: " + thisadd);
				
				let fetchlist = await fetchJSONData(thisadd);
				
				addAndCacheImages(thisadd, fetchlist);

				//loading another 50 wil pick up where this one left off
				nextmax = (images[0][0] - 1).toString();
				console.log("nextmax: " + nextmax);
			}

			async function loadDateRange() {			
				images = [];

				//max of 1024 loaded images.  Should reasonably not need more than 100 or you are using it wrong
				let fetchlist = await fetchJSONData(1024);

				//not going to deal with caching past images - just assume none of them are already loaded
				let imgs_loaded = fetchlist.length;
				
				console.log("images loaded: " + imgs_loaded.toString());


				slider.max = imgs_loaded;
				slider.value = imgs_loaded;

				addAndCacheImages(imgs_loaded, fetchlist);
			}

			async function addAndCacheImages(thisadd, fetchlist) {

				let jsonlist = [];
				for(let i = 0; i < thisadd ; i++) {
					let n = [];
					n.push(fetchlist[i]["imageTimestamp"]);
					n.push(fetchlist[i]["imageUrl"])
					jsonlist.push(n);	
				}

				console.log(jsonlist);

				imagestocache= [];
				for(let i = 0; i < thisadd ; i++){ 
					imagestocache.push(jsonlist[i][1]);
				}
				
				cacheimages(imagestocache, thisadd);
			
				//copy in global scope
				//var newimages = jsonlist.slice(0, slider.max);
				jsonlist.reverse();
				console.log(jsonlist);
				images = jsonlist.concat(images);
				console.log(jsonlist);

				recalculateSlider();

			}

			function addValue(v) {
				let intv = parseInt(v)
				let prev = parseInt(globvalue);
				result = (prev + v);
				//console.log(result)
				//console.log(globvalue)
				//console.log(slider.getAttribute("value"))
				slider.value = result;
				recalculateSlider();
			}

			function addAnother50() {
				//changerange
				changeRange(parseInt(slider.max) + 50);
			}


			let button = document.getElementsByTagName('button');
			button[1].addEventListener('click', function () {
				addValue(-1);
			})

			button[2].addEventListener('click', function () {
				addValue(1);
			})
			
			document.getElementById("loadbtn").addEventListener('click', function () {
				addAnother50();
			})

			changeRange('50');

			function hideElement(elementId) {
			  const element = document.getElementById(elementId);
			  if (element) {
			    element.style.display = 'none';
			  }
			}


			function showElement(elementId) {
			  const element = document.getElementById(elementId);
			  if (element) {
			    element.style.display = 'block';
			  }
			}
	
		</script>
    	</body>
</html>
